#!/usr/bin/env python
# -*- coding: utf-8 -*-
import re
import time

import requests
from bs4 import BeautifulSoup


def get_top_elements(lib_name, url):
    soup = BeautifulSoup(requests.get(url).text, features="lxml")
    # _9ba9a726 f4 tl flex-auto fw6 black-80 ma0 pr2 pb1
    week_down = soup.find("p", {"class": "_9ba9a726"}).text.strip()
    print((lib_name, week_down))
    return {
        "lib_name": lib_name,
        "week_down": week_down
    }


def write_to_csv(data, file_path):
    import csv

    keys = list(data[0].keys())
    with open(file_path, 'w') as output_file:
        dict_writer = csv.DictWriter(output_file, fieldnames=keys)
        dict_writer.writeheader()
        dict_writer.writerows(data)


def run():
    # libs = ['sequelize', 'marked', 'validator', 'electron', 'editor.md', 'bootstrap', 'serve', 'keystone', 'rendertron',
    #         'hapi', 'lodash', 'jquery-ui', 'jquery', 'npm', 'ejs', 'dns-sync', 'openpgp', 'handlebars', 'send', 'qs',
    #         'auth0-js', 'simplehttpserver', 'public', 'moment', 'remarkable', 'next', 'materialize-css', 'safer-eval',
    #         'uglify-js', 'is-my-json-valid', 'crud-file-server', 'status-board', 'keycloak-connect', 'i18next',
    #         'generator-jhipster', 'serialize-to-js', 'parse-server', 'ecstatic', 'tar', 'realms-shim',
    #         'http-live-simulator', 'http-file-server', 'html-pages', 'html-janitor', 'sanitize-html', 'hekto', 'harp',
    #         'mixin-deep', 'glance', 'mcstatic', 'buttle', 'mustache', 'localhost-now', 'mapbox.js', 'tough-cookie',
    #         'assign-deep', 'mqtt-packet', 'total.js', 'mathjs', 'm-server', 'ws', 'mongoose', 'mongo-express',
    #         'mongodb-instance', 'pg', 'pennyworth', 'mqtt', 'pdfinfojs', 'ms', 'msrcrypto', 'passport-wsfed-saml2',
    #         'mongose', 'pym.js', 'qbs', 'passport-azure-ad', 'mssql-node', 'mssql.js', 'mockserve', 'query-mysql',
    #         'parsejson', 'phantomjs-cheniu', 'picard', 'pk-app-wonderbox', 'mpath', 'protobufjs', 'product-monitor',
    #         'printer', 'morgan', 'morris.js', 'proxy.js', 'prince', 'mosca', 'prebuild-lwip', 'pouchdb',
    #         'pooledwebsocket', 'pomelo', 'poco', 'myserver.alexcthomas18', 'pngcrush-installer', 'plotly.js', 'ps',
    #         'node-fabric', 'parcel-bundler', 'mystem', 'node-jose', 'nodeffmpeg', 'nodefabric', 'nodecaffe', 'nes',
    #         'nodebb', 'nodeaaaaa', 'node.extend', 'node-tkinter', 'node-thulac', 'node-srv', 'node-sqlite',
    #         'node-simple-router', 'no-case', 'node-server-forfront', 'node-serialize', 'node-red-dashboard',
    #         'node-openssl', 'node-browser', 'node-bsdiff-android', 'node-opensl', 'node-opencv', 'nodemailer-js',
    #         'nodemailer.js', 'quickserver', 'open-device', 'mystem-fix', 'pannellum', 'operadriver', 'openssl.js',
    #         'mystem-wrapper', 'openframe-image', 'openframe-glslviewer', 'openframe-ascii-image', 'opencv.js',
    #         'nw-with-arm', 'negotiator', 'nw', 'nunjucks', 'ntfserver', 'mystem3', 'nodewebkit', 'nodesqlite',
    #         'nodeschnaps', 'noderequest', 'native-opencv', 'nodemssql', '22lixian', 'randomatic', 'sqlite.js', 'tomita',
    #         'tmock', 'tkinter', 'tinyserver2', 'tiny-json-http', 'timespan', 'tianma-static', 'tar-fs', 'takeapeek',
    #         'syntax-error', 'sync-exec', 'swagger-ui', 'superagent', 'string', 'strider-sauce', 'strapi', 'steroids',
    #         'stattic', 'statichttpserver', 'static-resource-server', 'static-html-server', 'static-eval', 'st', 'ssri',
    #         'sspa', 'sshpk', 'sqlserver', 'tomita-parser', 'ua-parser', 'uap-core', 'webpack-dev-server', 'yapi-vendor',
    #         'xterm', 'xd-testing', 'wixtoolset', 'windows-seleniumjar-mirror', 'windows-seleniumjar',
    #         'windows-iedriver', 'windows-build-tools', 'whispercast', 'whereis', 'webtorrent', 'webrtc-native',
    #         'webdrvr', 'unicode', 'webdriver-launcher', 'waterline-sequel', 'wasdk', 'verdaccio', 'valine',
    #         'utahcityfinder', 'useragent', 'url-parse', 'uri-js', 'unzipper', 'unicorn-list', 'unicode-json', 'sqliter',
    #         'socket.io', 'react-dev-utils', 'soci', 'selenium-download', 'selenium-chromedriver', 'selenium-binaries',
    #         'selectize-plugin-a11y', 'scalajs-standalone-bin', 'scala-bin', 'sauce-connect', 'samlify', 'saml2-js',
    #         'sails', 'safe-eval', 'rtcmulticonnection-client', 'rs-brightcove', 'robot-js', 'ritp', 'riot-compiler',
    #         'restify', 'restafary', 'resourcehacker', 'minimatch', 'request', 'renovate', 'reecerver',
    #         'reduce-css-calc', 'redis-srvr', 'react-native-baidu-voice-synthesizer', 'react-dom', 'selenium-portal',
    #         'selenium-standalone-painful', 'selenium-wrapper', 'shell-quote', 'smb', 'smartbanner.js', 'sly07', 'slug',
    #         'slpjs', 'slp-validate', 'slimerjs-edge', 'simplemde', 'simple-npm-registry', 'simple-markdown', 'simditor',
    #         'shout', 'shave', 'semver', 'shadowsock', 'sfml', 'sexstatic', 'set-value', 'serverxxx', 'serverabc',
    #         'serve-index', 'serve-here', 'serialize-javascript', 'serc.js', 'seneca', 'sencisho', 'resolve-path',
    #         'markdown-pdf', 'min-http-server', 'csrf-lite', 'debug', 'datachannel-client', 'dalek-browser-ie-canary',
    #         'dalek-browser-ie', 'dalek-browser-chrome-canary', 'dalek-browser-chrome', 'd3.js', 'cyberchef', 'cyber-js',
    #         'curses', 'cue-sdk-node', 'csv-parse', 'cryptiles', 'deep-extend', 'cryo', 'crumb', 'crossenv',
    #         'cordova-plugin-ionic-webview', 'cookie-signature', 'content', 'console-io', 'connect-pg-simple',
    #         'commentapp.stetsonwood', 'coffescript', 'coffe-script', 'cofeescript', 'decamelize', 'deeply',
    #         'codem-transcode', 'engine.io-client', 'eye.js', 'exxxxxxxxxxx', 'extend', 'express-restify-mongoose',
    #         'express-cart', 'express', 'exceljs', 'ewgaddis.lab6', 'event-stream', 'ethereumjs-vm', 'eslint-utils',
    #         'eslint-config-eslint', 'ember', 'default-deep', 'embedza', 'electron-packager', 'elding', 'egg-scripts',
    #         'easyquick', 'dwebp-bin', 'droppy', 'dojox', 'discordi.js', 'dgard8.lab6', 'desafio', 'defaults-deep',
    #         'cofee-script', 'cobalt-cli', 'mime', 'anywhere', 'backbone', 'babelcli', 'axios',
    #         'aws-lambda-multipart-parser', 'augustine', 'atom-node-module-installer', 'atob', 'arrayfire-js',
    #         'arcanist', 'appium-chromedriver', 'apk-parser2', 'apex-publish-static-files', 'angular-http-server',
    #         'baryton-saxophone', 'angular', 'alto-saxophone', 'airbrake', 'air-sdk', 'aerospike', 'aegir', 'aedes',
    #         'adm-zip', 'Haraka', '@risingstack/protect', '@nuxt/devalue', '@cubejs-backend/api-gateway',
    #         'badjs-sourcemap-server', 'bassmaster', 'co-cli-installer', 'censorify.tanisjr', 'cmake', 'cloudpub-redis',
    #         'closurecompiler', 'closure-util', 'cli', 'clang-extra', 'ckeditor', 'citypredict.whauwiller',
    #         'chromedriver126', 'chromedriver', 'charset', 'centra', 'calmquist.static-server', 'bionode-sra', 'call',
    #         'cached-path-relative', 'byucslabsix', 'bson', 'broccoli-closure', 'bracket-template', 'brace-expansion',
    #         'box2d-native', 'bower', 'blueimp-file-upload', 'bkjs-wand', 'bitty', 'f2e-server', 'fabric-js',
    #         'fast-http-cli', 'jquery.js', 'kindlegen', 'kill-port', 'jwt-simple', 'jvminstall', 'just-extend',
    #         'jstestdriver', 'jsonwebtoken', 'jshamcrest', 'jser-stat', 'js-yaml', 'js-given', 'jquey',
    #         'jquery-file-upload', 'knightjs', 'jpv', 'jn_jj_server', 'jikes', 'jdf-sass', 'jadedown', 'iter-http',
    #         'ipip-coffee', 'ipip', 'iobroker.web', 'iobroker.js-controller', 'intsol-package', 'install-nw', 'knex',
    #         'lab6.brit95', 'fastify', 'mariadb', 'method-override', 'metascraper', 'merge-recursive', 'merge-options',
    #         'merge-object', 'merge-deep', 'merge', 'memjs', 'mathjax', 'massif', '@ckeditor/ckeditor5-link',
    #         'marionette-socket-host', 'macaddress', 'lab6drewfusbyu', 'macaca-chromedriver-zxa', 'macaca-chromedriver',
    #         'ltt', 'looppake', 'lodahs', 'list-n-stream', 'limbus-buildgen', 'libxl', 'libsbmlsim', 'libsbml',
    #         'libnmap', 'larvitbase-api', 'install-g-test', 'insight-api', 'infraserver', 'geoip-lite-country',
    #         'grunt-webdriver-qunit', 'grunt-images', 'grunt-gh-pages', 'grunt-ccompiler', 'growl', 'goserv',
    #         'google-closure-tools-latest', 'gomeplus-h5-proxy', 'go-ipfs-dep', 'gitlabhook', 'git-dummy-commit',
    #         'getcityapi.yoehoehne', 'general-file-server', 'imageoptim', 'geddy', 'galenframework-cli', 'fuseki',
    #         'fresh', 'forwarded', 'forms', 'flintcms', 'fis-sass-all', 'fis-parser-sass-bin', 'fibjs', 'ffmepg',
    #         'fbr-client', 'gruntcli', 'gun', 'hapi-auth-jwt2', 'hawk', 'ikst', 'igniteui', 'iedriver', 'ibm_db',
    #         'ibapi', 'i18n-node-angular', 'hubl-server', 'httpsync', 'https-proxy-agent', 'http_static_simple',
    #         'http-signature', 'http-proxy.js', 'http-proxy', 'html-pdf', 'hostr', 'hoek', 'highcharts', 'hftp',
    #         'herbivore', 'healthcenter', 'headless-browser-lite', 'haxeshim', 'haxe3', 'haxe-dev', 'haxe', 'yarn']

    libs = ['default-deep']

    url_template = "https://www.npmjs.com/package/{:s}"
    output_path = '../data/npm_advisories_usages_failed'

    results = []
    failed = []
    for lib in libs:
        # for lib in libs[:5]:
        url = url_template.format(lib)
        print('Crawling from {:s}'.format(url))
        try:
            results.append(get_top_elements(lib, url))
            time.sleep(0.300)
        except:
            print('Failed {:s}'.format(lib))
            failed.append(lib)
            print('Putting to 1 second sleep')
            time.sleep(1)

    write_to_csv(results, output_path + '.csv')

    print('Crawled total {:d} records'.format(len(results)))
    print('Failed')
    print(failed)


if __name__ == "__main__":
    run()
